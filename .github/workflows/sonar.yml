name: Sonar Scan

on:
  push:
    branches: [ci]
  pull_request:
    branches: [master, development, "*_baseline"]

jobs:
  build-and-collect-coverage:
    name: Build & Collect Coverage
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests with coverage (ignore failures)
        continue-on-error: true
        run: |
          xcodebuild -quiet test \
            -project Split.xcodeproj \
            -scheme Split \
            -parallel-testing-enabled YES \
            -destination 'platform=iOS Simulator,OS=17.2,name=iPhone 15' \
            -enableCodeCoverage YES \
            -resultBundlePath build/Logs/Test/TestResults.xcresult \
            -derivedDataPath build

      - name: Export coverage to LCOV
        run: |
          set -euo pipefail

          mkdir -p coverage

          # Ensure DerivedData is at ./build (from test step)
          echo "📁 Listing profdata files under build/"
          find build -name "*.profdata" || true

          # Get the first .profdata file in the derived data path
          PROFRAW=$(find build -type f -name "*.profdata" | head -n 1 || true)
          if [[ -z "$PROFRAW" ]]; then
            echo "❌ Error: No .profdata file found under build/"
            exit 1
          fi

          echo "✅ Found profdata: $PROFRAW"

          # Find Split.framework binary in Debug config
          BINARY=$(find build -type f -path "*/Build/Products/Debug-iphonesimulator/Split.framework/Split" | head -n 1 || true)
          if [[ -z "$BINARY" ]]; then
            echo "❌ Error: Split binary not found under Debug-iphonesimulator/"
            find build -name "Split"  # Debugging output
            exit 1
          fi

          echo "✅ Found binary: $BINARY"

          # Export coverage to LCOV format
          xcrun llvm-cov export \
            -instr-profile "$PROFRAW" \
            "$BINARY" \
            -format=lcov > coverage/coverage.lcov

          echo "✅ coverage.lcov generated at: coverage/coverage.lcov"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/coverage.lcov

  sonar:
    name: Run SonarQube Scan
    runs-on: ubuntu-latest
    needs: build-and-collect-coverage
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage

      - name: Run SonarQube scan
        uses: sonarsource/sonarqube-scan-action@v5
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=splitio_ios-client
            -Dsonar.projectName=${{ github.event.repository.name }}
            -Dsonar.c.file.suffixes=-
            -Dsonar.cpp.file.suffixes=-
            -Dsonar.objc.file.suffixes=-
            -Dsonar.swift.coverage.reportPaths=coverage/coverage.lcov
        env:
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONARQUBE_HOST }}
